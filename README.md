# تفکیک آگهی‌های **روزنامهٔ رسمی** (۱۳۰۷ تا ۱۳۸۱)

این مخزن حاوی اسکریپت پایتونی است که نسخۀ اسکن‌شدۀ روزنامهٔ رسمی را—از **سال ۱۳۰۷ تا ۱۳۸۱ هجری خورشیدی**—به‌صورت کاملاً خودکار به **باکس‌های مجزای آگهی** تفکیک می‌کند.  
تصاویر روزنامه‌های خام از درگاه _ocr.rrk.ir_ بارگیری و سپس این اسکریپت روی تصاویر خروجی اعمال می‌شود تا هر آگهی را به‌شکل تصویر جداگانه استخراج کند. در نهایت توسط سرویس **[scanify.ir](https://scanify.ir)** به متن تبدیل (OCR) شده‌اند.

---

## فهرست محتوا

1. [پیش‌نیازها](#پیش‌نیازها)  
2. [نصب](#نصب)  
3. [ساختار پوشه‌ها](#ساختار-پوشه‌ها)  
4. [نحوهٔ اجرا](#نحوهٔ-اجرا)  
5. [پارامترهای کلیدی](#پارامترهای-کلیدی)  
6. [معرفی الگوریتم](#معرفی-الگوریتم)  
7. [نمونهٔ خروجی](#نمونهٔ-خروجی)  
8. [مجوز](#مجوز)  
9. [سپاس](#سپاس)

---

## پیش‌نیازها

| نرم‌افزار | نسخهٔ پیشنهادشده |
|-----------|------------------|
| Python    | 3.9 یا بالاتر    |
| OpenCV    | 4.x             |
| NumPy     | 1.23+           |
| scikit-learn | 1.4+         |
| tqdm      | 4.66+           |

> **نکته:** برای نصب سریع وابستگی‌ها می‌توانید از فایل `requirements.txt` (در صورت وجود) یا دستور زیر استفاده کنید:

```bash
pip install opencv-python-headless numpy scikit-learn tqdm
```


نصب
```bash
git clone https://github.com/<USER>/<REPO-NAME>.git
cd <REPO-NAME>
python -m venv .venv          # اختیاری ولی توصیه‌شده
source .venv/bin/activate     # یا .venv\Scripts\activate در ویندوز
pip install -r requirements.txt
```


## ساختار پوشه‌ها
```
.
├── input/          # تصاویر ورودی (سال/ماه/روز …)
├── boxes/          # خروجی: برش باکسیِ هر تصویر
├── result/         # خروجی: تصویر اصلی + مستطیل و شمارهٔ باکس‌ها
├── src/            # فایل‌های کد (در صورت تفکیک ماژول‌ها)
└── main.py         # نقطهٔ ورود (همین اسکریپت)
```
اسکریپت، پوشه‌های boxes/ و result/ را در صورت نبود، خود می‌سازد.

نحوهٔ اجرا

```bash
python main.py           # از ۱۳۸۱ تا ۱۳۰۷ (پیش‌فرض)
```

یا برای بازۀ دلخواه:

```python
START_YEAR = 1370
END_YEAR   = 1360
process_newspapers(START_YEAR, END_YEAR)
آرگومان‌های قابل تغییر (در بالای فایل)
ثابت	توضیح	مقدار پیش‌فرض
INPUT_DIR	ریشۀ تصاویر ورودی	./input
BOXES_DIR	ریشۀ ذخیرۀ باکس‌ها	./boxes
RESULT_DIR	ریشۀ خروجی نهایی	./result
…	سایر ثابت‌های پردازش تصویر	—
```

## پارامترهای کلیدی
نام متغیر	نقش	مقدار
KSIZE	اندازهٔ کرنل سوبل	3
THRESHOLD	آستانۀ هاف-لاین	26
MIN_LINE_LENGTH	حداقل طول خط عمودی	191
MIN_HORIZONTAL_LINE_LENGTH	حداقل طول خط افقی	140
HORIZONTAL_DILATATION / VERTICAL_DILATATION	ضخیم‌سازی متن	5 / 9
MAX_EXPANSION_DISTANCE	بیشینهٔ بُعد گسترش خط	50

برای دقت بیشتر می‌توانید این مقادیر را متناسب با رزولوشن تصاویرِ خود تنظیم کنید.

## معرفی الگوریتم
### پیش‌پردازش
تبدیل تصویر به خاکستری و محاسبهٔ گرادیان‌های سوبل (x و y).

### تقویت خطوط
آستانه‌گذاری اُتسو + عملیات باز (morph open) برای جداسازی خطوط افقی و عمودی.

### شناسایی خطوط
هاف لاین + گسترش تطبیقی برای ترسیم خطوط کامل شبکه.

### حذف خطوط
کم‌کردن خطوط از تصویر دودویی جهت حفظ تنها محتوای متنی.

### ضخیم‌سازی و پرکردن متن
اتساع (dilate) و پرکردن کانتور برای اتصال بخش‌های جدا افتاده.

### ایجاد باکس اولیه
رسم مستطیل دور هر کانتور و حذف تداخل با خطوط.

### فیلتر و مرتب‌سازی
فیلترمند اندازه، نسبت طول‌به‌عرض و هم‌پوشانی؛ سپس خوشه‌بندی K-Means برای تشخیص ستون‌ها و مرتب‌سازی راست→چپ و بالا→پایین.

### استخراج نهایی
کشیدن مستطیل روی نسخهٔ رنگی تصویر و برش هر باکس در مسیر boxes/.

### نمونهٔ خروجی
تصویر اصلی با باکس‌ها	باکس‌های استخراج‌شده

(تصاویر نمونه را در پوشهٔ docs/ قرار دهید.)

## مجوز
این پروژه تحت مجوز MIT منتشر شده است؛ برای اطلاعات بیشتر به فایل LICENSE رجوع کنید.

## سپاس
از **[وحید باقی](https://github.com/vahidbaghi)**  برای ایده‌ها و نوشتن کد، و همچنین از سرویس scanify.ir برای ارائهٔ OCR فارسی باکیفیت، صمیمانه تشکر می‌کنم. 🙏
